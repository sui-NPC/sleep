<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>睡眠・PVT習慣アプリ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:sans-serif; margin:0; background:#f9f9f9; color:#333;}
header { background:#4a90e2; color:white; text-align:center; padding:1rem;}
section { padding:1rem;}
.card { background:white; padding:1rem; margin:1rem; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.feedback { margin-top:1rem; font-weight:bold; color:#e67e22;}
canvas { max-width:100%; }
#pvt-area { margin-top:1rem; height:200px; border:2px solid #4a90e2; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#f0f8ff; font-size:2rem; user-select:none; cursor:pointer;}
#calendar { border-collapse:collapse; width:100%; margin-top:0.5rem;}
#calendar th, #calendar td { border:1px solid #ccc; width:14.2%; height:80px; text-align:center; vertical-align:top; cursor:pointer;}
#calendar th { background:#eee;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;}
.modal-content { background:#fff; padding:1rem; border-radius:10px; width:300px;}
#toggle-calendar { margin-bottom:0.5rem; }
</style>
</head>
<body>
<header><h1>睡眠・集中習慣アプリ</h1></header>

<!-- グラフ -->
<section class="card">
<h2>グラフ</h2>
<canvas id="dataChart"></canvas>
</section>

<!-- 睡眠記録 -->
<section class="card">
<h2>睡眠記録</h2>
<button onclick="recordSleep()">就寝記録</button>
<button onclick="recordWake()">起床記録</button>
<p id="sleep-feedback" class="feedback"></p>
</section>

<!-- PVTテスト -->
<section class="card">
<h2>PVTテスト</h2>
<button onclick="startPVT()">テスト開始</button>
<div id="pvt-area">準備中...</div>
<p id="pvt-feedback" class="feedback"></p>
</section>

<!-- カレンダー修正タブ -->
<section class="card">
<h2>カレンダー修正</h2>
<button id="toggle-calendar" onclick="toggleCalendar()">カレンダーを表示/非表示</button>
<table id="calendar" style="display:none;"></table>
</section>

<!-- モーダル -->
<div id="edit-modal" class="modal">
<div class="modal-content">
<h3>データ修正</h3>
<label>睡眠時間(h): <input type="number" step="0.1" id="edit-bed"></label><br>
<label>PVT平均(ms): <input type="number" id="edit-pvt" min="0"></label><br>
<button id="save-edit">保存</button>
<button id="close-modal">閉じる</button>
</div>
</div>

<script>
// データ管理
let sleepHistory = JSON.parse(localStorage.getItem("sleepHistory")||"[]");
let pvtHistory = JSON.parse(localStorage.getItem("pvtHistory")||"[]");
let sleepTime = null;
let selectedDate = null;

// グラフ
const ctx = document.getElementById('dataChart').getContext('2d');
const chart = new Chart(ctx,{
type:'line',
data:{labels:[], datasets:[
  {label:'睡眠時間 (h)', data:[], borderColor:'blue', yAxisID:'y1'},
  {label:'反応時間 (ms)', data:[], borderColor:'red', yAxisID:'y2'}
]},
options:{responsive:true, scales:{y1:{type:'linear',position:'left',min:0,max:12}, y2:{type:'linear',position:'right',min:0,max:1000}}}
});

function updateChart(){
let dates = [...new Set([...sleepHistory.map(d=>d.date), ...pvtHistory.map(d=>d.date)])];
chart.data.labels = dates;
chart.data.datasets[0].data = dates.map(d=>{let rec=sleepHistory.find(r=>r.date===d); return rec ? rec.hours : null;});
chart.data.datasets[1].data = dates.map(d=>{let rec=pvtHistory.find(r=>r.date===d); return rec ? rec.avg : null;});
chart.update();
}

// 睡眠記録
function recordSleep(){ sleepTime = new Date(); document.getElementById("sleep-feedback").textContent="就寝記録しました: "+sleepTime.toLocaleTimeString();}
function recordWake(){
  let wakeTime = new Date();
  if(sleepTime){
    let diff = (wakeTime - new Date(sleepTime))/1000/3600;
    let msg="睡眠時間: "+diff.toFixed(1)+"時間";
    if(diff<6) msg+=" → 睡眠不足⚠️"; else if(diff>=7&&diff<=9) msg+=" → 良好👍"; else msg+=" → 長すぎ注意😴";
    document.getElementById("sleep-feedback").textContent=msg;
    sleepHistory.push({date:new Date().toLocaleDateString(), hours:diff});
    localStorage.setItem("sleepHistory",JSON.stringify(sleepHistory));
    updateChart();
  }
}

// PVTテスト（15回固定、枠内クリック、個別フィードバック）
function startPVT(){
  const area = document.getElementById("pvt-area");
  const feedback = document.getElementById("pvt-feedback");
  feedback.textContent="";
  const totalTrials = 15;
  let trialDone = 0;
  let trialTimes = [];

  function runTrial(){
    if(trialDone>=totalTrials){
      const avg = trialTimes.reduce((a,b)=>a+b,0)/trialTimes.length;
      const lapses = trialTimes.filter(t=>t>500).length;
      // 最終フィードバック
      let finalMsg = `平均: ${avg.toFixed(1)}ms, ラプス: ${lapses}回 → `;
      if(avg>500) finalMsg+="注意力低下⚠️"; else finalMsg+="良好👌";
      feedback.textContent = finalMsg;
      const today = new Date().toLocaleDateString();
      pvtHistory.push({date:today, avg, lapses, reactions:trialTimes});
      localStorage.setItem("pvtHistory",JSON.stringify(pvtHistory));
      area.textContent="完了";
      updateChart();
      return;
    }

    area.textContent="準備中...";
    setTimeout(()=>{
      area.textContent="クリック！";
      const start = performance.now();
      const clickHandler = ()=>{
        const rt = performance.now()-start;
        trialTimes.push(rt);
        trialDone++;
        // 個別フィードバック
        let msg = `試行${trialDone}: ${rt.toFixed(0)}ms → `;
        if(rt>500) msg+="注意力低下⚠️"; else msg+="良好👌";
        feedback.textContent = msg;
        area.removeEventListener("click", clickHandler);
        runTrial();
      };
      area.addEventListener("click", clickHandler);
    }, Math.random()*3000+2000);
  }

  runTrial();
}

// カレンダー折りたたみ
function toggleCalendar(){
  const cal = document.getElementById("calendar");
  if(cal.style.display==="none"){ cal.style.display="table"; renderCalendar(); }
  else cal.style.display="none";
}

// カレンダー描画
function renderCalendar(){
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year,month,1).getDay();
  const lastDate = new Date(year,month+1,0).getDate();
  let html="<tr><th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th></tr><tr>";
  for(let i=0;i<firstDay;i++) html+="<td></td>";
  for(let d=1;d<=lastDate;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const sleepRec = sleepHistory.find(r=>r.date===dateStr)?.hours||"";
    const pvtRec = pvtHistory.find(r=>r.date===dateStr)?.avg||"";
    html+=`<td data-date="${dateStr}"><strong>${d}</strong><br>${sleepRec}h<br>${pvtRec}ms</td>`;
    if((d+firstDay)%7===0) html+="</tr><tr>";
  }
  html+="</tr>";
  document.getElementById("calendar").innerHTML=html;

  document.querySelectorAll("#calendar td[data-date]").forEach(td=>{
    td.onclick=()=>{
      selectedDate = td.dataset.date;
      document.getElementById("edit-bed").value = sleepHistory.find(r=>r.date===selectedDate)?.hours||"";
      document.getElementById("edit-pvt").value = pvtHistory.find(r=>r.date===selectedDate)?.avg||"";
      document.getElementById("edit-modal").style.display="flex";
    };
  });
}

// モーダル操作
document.getElementById("save-edit").onclick=()=>{
  if(selectedDate){
    const sleepVal=parseFloat(document.getElementById("edit-bed").value);
    const pvtVal=parseInt(document.getElementById("edit-pvt").value);
    let sIndex = sleepHistory.findIndex(r=>r.date===selectedDate);
    if(sIndex>=0) sleepHistory[sIndex].hours=sleepVal;
    else sleepHistory.push({date:selectedDate,hours:sleepVal});
    let pIndex = pvtHistory.findIndex(r=>r.date===selectedDate);
    if(pIndex>=0) pvtHistory[pIndex].avg=pvtVal;
    else pvtHistory.push({date:selectedDate,avg:pvtVal,lapses:0,reactions:[]});
    localStorage.setItem("sleepHistory",JSON.stringify(sleepHistory));
    localStorage.setItem("pvtHistory",JSON.stringify(pvtHistory));
    updateChart();
    renderCalendar();
    document.getElementById("edit-modal").style.display="none";
  }
};
document.getElementById("close-modal").onclick=()=>{document.getElementById("edit-modal").style.display="none";};

// 初期描画
updateChart();
</script>
</body>
</html>
