<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¡çœ ãƒ»PVTç¿’æ…£ã‚¢ãƒ—ãƒª</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:sans-serif; margin:0; background:#f9f9f9; color:#333;}
header { background:#4a90e2; color:white; text-align:center; padding:1rem;}
section { padding:1rem;}
.card { background:white; padding:1rem; margin:1rem; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.feedback { margin-top:1rem; font-weight:bold; color:#e67e22;}
canvas { max-width:100%; }
#pvt-area { margin-top:1rem; height:200px; border:2px solid #4a90e2; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#f0f8ff; font-size:2rem; user-select:none; cursor:pointer;}
#calendar { border-collapse:collapse; width:100%; margin-top:0.5rem;}
#calendar th, #calendar td { border:1px solid #ccc; width:14.2%; height:80px; text-align:center; vertical-align:top; cursor:pointer;}
#calendar th { background:#eee;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;}
.modal-content { background:#fff; padding:1rem; border-radius:10px; width:300px;}
#toggle-calendar { margin-bottom:0.5rem; }
button {
  padding: 1rem 1.5rem;
  font-size: 1.2rem;
  border-radius: 8px;
  border: none;
  background: #4a90e2;
  color: white;
  cursor: pointer;
  margin: 0.5rem 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
button:hover { background: #357ab8; }

#today-pvt-reminder {
  display:none;
  position:fixed;
  top:0; width:100%;
  background:yellow; color:black; font-weight:bold;
  justify-content:center; align-items:center;
  padding:1rem; cursor:pointer; z-index:1000;
  text-align:center;
}
#data-copy { background:#f39c12; margin-top:0.5rem; }
</style>
</head>
<body>
<header><h1>ç¡çœ ãƒ»é›†ä¸­ç¿’æ…£ã‚¢ãƒ—ãƒª</h1></header>

<!-- ä»Šæ—¥ã®PVTãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
<div id="today-pvt-reminder">ä»Šæ—¥ã®PVTæœªå®Ÿæ–½ã§ã™ï¼ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆé–‹å§‹</div>

<!-- ã‚°ãƒ©ãƒ• -->
<section class="card">
<h2>ã‚°ãƒ©ãƒ•</h2>
<canvas id="dataChart"></canvas>
</section>

<!-- ç¡çœ è¨˜éŒ² -->
<section class="card">
<h2>ç¡çœ è¨˜éŒ²</h2>
<button onclick="recordSleep()">å°±å¯è¨˜éŒ²</button>
<button onclick="recordWake()">èµ·åºŠè¨˜éŒ²</button>
<p id="sleep-feedback" class="feedback"></p>
</section>

<!-- PVTãƒ†ã‚¹ãƒˆ -->
<section class="card" id="pvt-section">
<h2>åå¿œé€Ÿåº¦ãƒ†ã‚¹ãƒˆ</h2>
<button onclick="startPVT()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
<div id="pvt-area">æº–å‚™ä¸­...</div>
<p id="pvt-feedback" class="feedback"></p>
</section>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¿®æ­£ã‚¿ãƒ– -->
<section class="card">
<h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¿®æ­£</h2>
<button id="toggle-calendar" onclick="toggleCalendar()">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
<table id="calendar" style="display:none;"></table>
<br>
<button id="clear-data" style="background:#e74c3c; color:white; font-weight:bold;">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
<button id="data-copy">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
</section>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal" class="modal">
<div class="modal-content">
<h3>ãƒ‡ãƒ¼ã‚¿ä¿®æ­£</h3>
<label>ç¡çœ æ™‚é–“(h): <input type="number" step="0.1" id="edit-bed"></label><br>
<label>PVTå¹³å‡(ms): <input type="number" id="edit-pvt" min="0"></label><br>
<button id="save-edit">ä¿å­˜</button>
<button id="delete-entry" style="background:#e74c3c; color:white;">å‰Šé™¤</button>
<button id="close-modal">é–‰ã˜ã‚‹</button>
</div>
</div>

<script>
// ãƒ‡ãƒ¼ã‚¿ç®¡ç†
let sleepHistory = JSON.parse(localStorage.getItem("sleepHistory")||"[]");
let pvtHistory = JSON.parse(localStorage.getItem("pvtHistory")||"[]");
let sleepTime = null;
let selectedDate = null;

function getDateString(date){ return date.toISOString().split("T")[0]; }

// ã‚°ãƒ©ãƒ•
const ctx = document.getElementById('dataChart').getContext('2d');
const chart = new Chart(ctx,{
type:'line',
data:{labels:[], datasets:[
  {label:'ç¡çœ æ™‚é–“ (h)', data:[], borderColor:'blue', yAxisID:'y1'},
  {label:'åå¿œæ™‚é–“ (ms)', data:[], borderColor:'red', yAxisID:'y2'}
]},
options:{responsive:true, scales:{y1:{type:'linear',position:'left',min:0,max:12}, y2:{type:'linear',position:'right',min:0,max:1000}}}
});

function updateChart(){
  let dates = [...new Set([
    ...sleepHistory.filter(r => r.hours != null && r.hours !== 0).map(r=>r.date),
    ...pvtHistory.filter(r => r.avg != null && r.avg !== 0).map(r=>r.date)
  ])];
  dates.sort((a,b)=> new Date(a)-new Date(b));
  chart.data.labels = dates;
  chart.data.datasets[0].data = dates.map(d=>{
    let rec = sleepHistory.find(r=>r.date===d); return rec ? rec.hours : null;
  });
  chart.data.datasets[1].data = dates.map(d=>{
    let rec = pvtHistory.find(r=>r.date===d); return rec ? rec.avg : null;
  });
  chart.update();
}

// ç¡çœ è¨˜éŒ²
function recordSleep(){ sleepTime=new Date(); document.getElementById("sleep-feedback").textContent="å°±å¯è¨˜éŒ²ã—ã¾ã—ãŸ: "+sleepTime.toLocaleTimeString();}
function recordWake(){
  let wakeTime=new Date();
  if(sleepTime){
    let diff=(wakeTime-new Date(sleepTime))/1000/3600;
    let msg="ç¡çœ æ™‚é–“: "+diff.toFixed(1)+"æ™‚é–“";
    if(diff<6) msg+=" â†’ ç¡çœ ä¸è¶³âš ï¸"; else if(diff>=7&&diff<=9) msg+=" â†’ è‰¯å¥½ğŸ‘"; else msg+=" â†’ é•·ã™ãæ³¨æ„ğŸ˜´";
    document.getElementById("sleep-feedback").textContent=msg;
    sleepHistory.push({date:getDateString(new Date()), hours:diff});
    localStorage.setItem("sleepHistory",JSON.stringify(sleepHistory));
    updateChart();
  }
}

// PVTãƒ†ã‚¹ãƒˆ
function startPVT(){
  const area=document.getElementById("pvt-area");
  const feedback=document.getElementById("pvt-feedback");
  feedback.textContent="";
  const totalTrials=15;
  let trialDone=0;
  let trialTimes=[];
  function runTrial(){
    if(trialDone>=totalTrials){
      const avg=trialTimes.reduce((a,b)=>a+b,0)/trialTimes.length;
      const lapses=trialTimes.filter(t=>t>500).length;
      let finalMsg=`å¹³å‡: ${avg.toFixed(1)}ms, ãƒ©ãƒ—ã‚¹: ${lapses}å› â†’ `;
      if(avg>500) finalMsg+="æ³¨æ„åŠ›ä½ä¸‹âš ï¸"; else finalMsg+="è‰¯å¥½ğŸ‘Œ";
      feedback.textContent=finalMsg;
      const today=getDateString(new Date());
      pvtHistory.push({date:today, avg, lapses, reactions:trialTimes});
      localStorage.setItem("pvtHistory",JSON.stringify(pvtHistory));
      area.textContent="å®Œäº†";
      updateChart();
      hidePVTReminder();
      return;
    }
    area.textContent="æº–å‚™ä¸­...";
    setTimeout(()=>{
      area.textContent="ã‚¯ãƒªãƒƒã‚¯ï¼";
      const start=performance.now();
      const clickHandler=()=>{
        const rt=performance.now()-start;
        trialTimes.push(rt);
        trialDone++;
        feedback.textContent=`è©¦è¡Œ${trialDone}: ${rt.toFixed(0)}ms â†’ ${rt>500?"æ³¨æ„åŠ›ä½ä¸‹âš ï¸":"è‰¯å¥½ğŸ‘Œ"}`;
        area.removeEventListener("click", clickHandler);
        runTrial();
      };
      area.addEventListener("click", clickHandler);
    }, Math.random()*3000+2000);
  }
  runTrial();
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
function toggleCalendar(){
  const cal=document.getElementById("calendar");
  if(cal.style.display==="none"){ cal.style.display="table"; renderCalendar(); }
  else cal.style.display="none";
}
function renderCalendar(){
  const today=new Date();
  const year=today.getFullYear();
  const month=today.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const lastDate=new Date(year,month+1,0).getDate();
  let html="<tr><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr><tr>";
  for(let i=0;i<firstDay;i++) html+="<td></td>";
  for(let d=1;d<=lastDate;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const sleepRec=sleepHistory.find(r=>r.date===dateStr)?.hours||"";
    const pvtRec=pvtHistory.find(r=>r.date===dateStr)?.avg||"";
    html+=`<td data-date="${dateStr}"><strong>${d}</strong><br>${sleepRec}h<br>${pvtRec}ms</td>`;
    if((d+firstDay)%7===0) html+="</tr><tr>";
  }
  html+="</tr>";
  document.getElementById("calendar").innerHTML=html;
  document.querySelectorAll("#calendar td[data-date]").forEach(td=>{
    td.onclick=()=>{
      selectedDate=td.dataset.date;
      document.getElementById("edit-bed").value=sleepHistory.find(r=>r.date===selectedDate)?.hours||"";
      document.getElementById("edit-pvt").value=pvtHistory.find(r=>r.date===selectedDate)?.avg||"";
      document.getElementById("edit-modal").style.display="flex";
    };
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
document.getElementById("delete-entry").onclick=()=>{
  if(selectedDate && confirm(`${selectedDate} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
    sleepHistory=sleepHistory.filter(r=>r.date!==selectedDate);
    pvtHistory=pvtHistory.filter(r=>r.date!==selectedDate);
    localStorage.setItem("sleepHistory",JSON.stringify(sleepHistory));
    localStorage.setItem("pvtHistory",JSON.stringify(pvtHistory));
    updateChart(); renderCalendar();
    document.getElementById("edit-modal").style.display="none";
  }
};
document.getElementById("save-edit").onclick=()=>{
  if(selectedDate){
    const sleepVal=parseFloat(document.getElementById("edit-bed").value);
    const pvtVal=parseInt(document.getElementById("edit-pvt").value);
    let sIndex=sleepHistory.findIndex(r=>r.date===selectedDate);
    if(sIndex>=0) sleepHistory[sIndex].hours=sleepVal;
    else sleepHistory.push({date:selectedDate,hours:sleepVal});
    let pIndex=pvtHistory.findIndex(r=>r.date===selectedDate);
    if(pIndex>=0) pvtHistory[pIndex].avg=pvtVal;
    else pvtHistory.push({date:selectedDate,avg:pvtVal,lapses:0,reactions:[]});
    localStorage.setItem("sleepHistory",JSON.stringify(sleepHistory));
    localStorage.setItem("pvtHistory",JSON.stringify(pvtHistory));
    updateChart(); renderCalendar();
    document.getElementById("edit-modal").style.display="none";
  }
};
document.getElementById("close-modal").onclick=()=>{document.getElementById("edit-modal").style.display="none";};

// å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
document.getElementById("clear-data").onclick=()=>{
  if(confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.clear(); sleepHistory=[]; pvtHistory=[];
    updateChart(); renderCalendar(); alert("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }
};

// ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼
document.getElementById("data-copy").onclick=()=>{
  const data={sleepHistory,pvtHistory};
  navigator.clipboard.writeText(JSON.stringify(data,null,2)).then(()=>{
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
  });
};

// åˆå¾ŒPVTãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
function showDailyPVTReminder(){
  const now=new Date();
  if(now.getHours()>=12){
    const today=getDateString(now);
    const done=pvtHistory.some(r=>r.date===today);
    if(!done){
      document.getElementById("today-pvt-reminder").style.display="flex";
    }
  }
}
function hidePVTReminder(){ document.getElementById("today-pvt-reminder").style.display="none"; }

document.getElementById("today-pvt-reminder").onclick=()=>{
  document.getElementById("pvt-section").scrollIntoView({behavior:"smooth"});
  hidePVTReminder();
};

// åˆæœŸæç”»
updateChart();
renderCalendar();
showDailyPVTReminder();
</script>
</body>
</html>
